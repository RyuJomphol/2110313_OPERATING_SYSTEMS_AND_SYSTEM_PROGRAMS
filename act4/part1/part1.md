# โปรแกรม fork() และ execvp() (รับคำสั่งจาก Command Line)

เอกสารฉบับนี้เป็น **เฉลยแบบไกด์** สำหรับอธิบายโปรแกรมที่ใช้ `fork()` และ `execvp()` โดยดัดแปลงจากตัวอย่างเดิม ให้สามารถ **รับคำสั่ง Linux จาก argument** และทำงานตามคำสั่งที่ผู้ใช้ป้อน

---

## 1. อธิบายฟังก์ชันที่ใช้ในโปรแกรม

### 1.1 `main(int argc, char *argv[])`

* `argc` (argument count) คือจำนวน argument ที่ป้อนเข้ามา
* `argv` (argument vector) คืออาเรย์ของ string ที่เก็บ argument
* `argv[0]` คือชื่อโปรแกรม
* `argv[1]` เป็นต้นไป คือคำสั่ง Linux และ option ที่ผู้ใช้ป้อน

ตัวอย่าง:

```
./run ls -l
argc = 3
argv[1] = "ls"
argv[2] = "-l"
```

---

### 1.2 `fork()`

* ใช้สร้าง **process ลูก** จาก process แม่
* ค่าที่คืนกลับ:

  * `< 0` : เกิดข้อผิดพลาด
  * `= 0` : อยู่ใน process ลูก
  * `> 0` : อยู่ใน process แม่ (ค่าเป็น PID ของลูก)

---

### 1.3 `execvp()`

* ใช้แทนที่โปรแกรมใน process ปัจจุบันด้วยคำสั่ง Linux ใหม่
* รูปแบบ:

```
execvp(char *file, char *argv[]);
```

* ในโปรแกรมนี้ใช้:

```
execvp(argv[1], &argv[1]);
```

ซึ่งหมายความว่า

* `argv[1]` คือชื่อคำสั่ง (เช่น `ls`, `cal`)
* `&argv[1]` คือ argument ทั้งหมดของคำสั่งนั้น

---

### 1.4 `wait()`

* ใช้ให้ process แม่รอจนกว่า process ลูกจะทำงานเสร็จ
* ป้องกันไม่ให้เกิด zombie process

---

### 1.5 `perror()`

* ใช้แสดงข้อความ error ของระบบ
* เหมาะสำหรับใช้เมื่อ `fork()` หรือ `execvp()` ล้มเหลว

---

## 2. อธิบายจุดที่แก้ไขจากโปรแกรมเดิม

### 2.1 เปลี่ยน `main()` ให้รับ argument

**เดิม**

```c
int main()
```

**แก้ไขเป็น**

```c
int main(int argc, char *argv[])
```

เพื่อให้โปรแกรมรับคำสั่งจาก command line ได้

---

### 2.2 ตรวจสอบว่าผู้ใช้ป้อนคำสั่งหรือไม่

```c
if (argc < 2) {
    printf("Error: Please provide a command to execute.\n");
    printf("Usage: %s <command> [options]\n", argv[0]);
    exit(1);
}
```

* ถ้า `argc < 2` แสดงว่าผู้ใช้ **ไม่ป้อนคำสั่ง Linux**
* โปรแกรมจะแสดงข้อความแจ้งเตือนและหยุดทำงานทันที

---

### 2.3 ใช้ `execvp()` แทนคำสั่งที่ fix ค่าไว้

**โปรแกรมเดิม**

```c
char *av[] = {"cal","3","2021",(char *)0};
execvp("cal", av);
```

**โปรแกรมที่แก้ไข**

```c
execvp(argv[1], &argv[1]);
```

* ทำให้โปรแกรมสามารถรัน **คำสั่งใดก็ได้** ตามที่ผู้ใช้ป้อน
* รองรับ option เพิ่มเติม เช่น

```
./run ls -l /home
./run cal 3 2021
```

---

### 2.4 โครงสร้างการทำงานของโปรแกรม

1. โปรแกรมเริ่มทำงาน
2. ตรวจสอบ argument
3. process แม่เรียก `fork()`
4. process ลูกเรียก `execvp()` เพื่อรันคำสั่ง Linux
5. process แม่เรียก `wait()` รอให้ลูกทำงานเสร็จ
6. โปรแกรมหยุดทำงาน

---

