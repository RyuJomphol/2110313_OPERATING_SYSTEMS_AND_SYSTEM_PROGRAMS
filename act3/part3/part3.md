# Activity 3.3: การพิมพ์ข้อความจากโปรเซสแบบย้อนลำดับ

กิจกรรมนี้มีวัตถุประสงค์เพื่อให้น้อง ๆ เข้าใจ **ลำดับการสร้างโปรเซส (process creation order)** และการควบคุมลำดับการทำงานของโปรเซสโดยใช้คำสั่ง `fork()` และ `wait()` เพื่อให้โปรเซสที่ถูกสร้างขึ้น **หลังสุดพิมพ์ข้อความก่อน** และโปรเซสที่ถูกสร้างขึ้น **ก่อนสุดพิมพ์ข้อความหลังสุด**

---

## 1. อธิบายคำสั่งที่ใช้

### 1.1 `fork()`

`fork()` เป็น system call ที่ใช้สร้างโปรเซสใหม่ (child process) จากโปรเซสเดิม (parent process)

ค่าที่ `fork()` ส่งกลับมา:

* `< 0` : การสร้างโปรเซสล้มเหลว
* `0` : อยู่ใน child process
* `> 0` : อยู่ใน parent process และค่าที่ได้คือ PID ของ child

ในโจทย์นี้ `fork()` ถูกเรียกหลายครั้งเพื่อสร้างโปรเซสเป็นลำดับชั้น (process chain)

---

### 1.2 `wait()`

`wait()` ใช้สำหรับให้ **parent process รอ** จนกว่า child process จะทำงานเสร็จ

ผลที่เกิดขึ้น:

* ควบคุมลำดับการทำงานของโปรเซส
* ป้องกันการเกิด zombie process

ในโจทย์นี้ `wait()` เป็นหัวใจสำคัญที่ทำให้ลำดับการพิมพ์ข้อความถูกย้อนกลับ

---

### 1.3 `getpid()` และ `getppid()`

* `getpid()` : ใช้แสดง PID ของโปรเซสปัจจุบัน
* `getppid()` : ใช้แสดง PID ของโปรเซสแม่

ใช้เพื่อยืนยันลำดับความสัมพันธ์ของโปรเซสที่ถูกสร้างขึ้น

---

## 2. อธิบายการทำงานของโค้ด

### 2.1 การกำหนดค่าเริ่มต้น

```c
int i;
int n = 4;
pid_t childpid;
```

* `n = 4` หมายถึงจะมีการเรียก `fork()` สูงสุด 4 ครั้ง
* ทำให้เกิดโปรเซสทั้งหมด 5 ตัว (รวม parent แรกสุด)

---

### 2.2 การสร้างโปรเซสด้วยลูป

```c
for (i = 0; i < n; ++i) {
    childpid = fork();

    if (childpid > 0) {
        break;
    }
}
```

ลักษณะการทำงาน:

* child process จะวนลูปต่อและสร้าง child ตัวถัดไป
* parent process จะออกจากลูปทันทีด้วย `break`

ผลลัพธ์คือได้โครงสร้างโปรเซสแบบ **สายโซ่ (chain)**

---

### 2.3 การควบคุมลำดับด้วย `wait()` (จุดที่แก้สำคัญ)

```c
wait(NULL);
```

**จุดที่แก้ไขจากโค้ดเดิมในโจทย์**:

* ย้าย `wait()` มาไว้ก่อน `printf()`
* ทำให้ parent ต้องรอให้ child พิมพ์ข้อความก่อน

ผลที่เกิดขึ้น:

* โปรเซสที่อยู่ล่างสุด (สร้างหลังสุด) จะไม่มีลูก → ไม่ต้องรอ → พิมพ์ก่อน
* โปรเซสที่สร้างก่อน จะพิมพ์ทีหลังตามลำดับย้อนกลับ

---

### 2.4 การพิมพ์ข้อความ

```c
printf("This is process %ld with parent %ld\n",
       (long)getpid(), (long)getppid());
```

แต่ละโปรเซสจะแสดง:

* PID ของตนเอง
* PID ของ parent

ซึ่งจะปรากฏตามลำดับย้อนกลับจาก child → parent → ... → parent แรกสุด

---

## 3. สรุปภาพรวมการทำงานของโปรแกรม

แนวคิดหลักของโจทย์นี้คือ:

* ใช้ `fork()` สร้างโปรเซสแบบ chain
* ใช้ `wait()` บังคับให้ parent รอ child
* ทำให้ลำดับการพิมพ์ข้อความ **ย้อนจากโปรเซสที่สร้างล่าสุดไปหาโปรเซสแรกสุด**

ผลลัพธ์ที่ได้จะเป็นไปตามตัวอย่าง:

```
This is process 34 with parent 33
This is process 33 with parent 32
This is process 32 with parent 31
This is process 31 with parent 30
This is process 30 with parent 9
```